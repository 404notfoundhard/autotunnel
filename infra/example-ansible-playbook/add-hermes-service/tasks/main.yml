---
# tasks file for add-hermes-service
- name: prepapre web-server distr
  hosts: localhost
  gather_facts: false
  tasks:
    - name: zip web-server distr
      archive:
        path:
        - "/{{web-server-src}}/*"
        exclude_path:
        - "/{{web-server-src}}/hermes.service"
        dest: ./add-hermes-service/files/web-server.zip
        format: zip

- name: Copy zip web-server to server 
  copy:
    src: web-server.zip
    dest: /srv/api-client.zip
    owner: root
    group: root
    mode: u=rw,g=r
    remote_src: no

- name: dev locale
  action: command sudo update-locale LC_ALL=en_US.UTF-8

- name: set default locale
  lineinfile: dest=/etc/default/locale
    regexp="LC_ALL"
    line="LC_ALL=\"en_US.UTF-8\""

- name: install required packages
  apt:
    name: "{{ required_packages }}"
    update_cache: yes
  ignore_errors: True
  register: python36_notfound

- name: add python3.6 repo if install failed
  apt_repository:
    repo: ppa:deadsnakes/ppa
    update_cache: yes
  when: python36_notfound != 0
  register: python36_repo_add

- name: install required packages when add repository
  apt:
    name: "{{ required_packages }}"
    update_cache: yes
  when: python36_repo_add is succeeded

- name: unzip web-server.zip
  unarchive:
      src: /srv/web-server.zip
      dest: /srv/
      remote_src: yes

- name: Install virtualenv via pip
  pip:
    name: "{{pip_packages}}"
    executable: pip3

- name: create python virtual environment and install requirements
  pip:
     requirements: /srv/web-server/requirements.txt
     virtualenv: /srv/web-server/venv
     virtualenv_python: python3.6

# - name: create ssh-key
  # openssh_keypair:
    # force: yes
    # owner: root
    # path: /root/.ssh/key
    # size: 2048

# - name: call ssh-copy-id
#   command: sshpass -p test_pass ssh-copy-id -i /root/.ssh/key.pub -o StrictHostKeyChecking=no test_user@10.10.10.1

- name: copy hephaestus.service
  template:
    dest: /etc/systemd/system/hermes.service
    src: hermes.service.j2
    owner: root
    group: root
  notify:
  - Restart hephaestus and reload daemon
